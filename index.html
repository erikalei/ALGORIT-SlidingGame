<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NUMSHIFT - Sliding Puzzle Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="top-right-buttons" id="global-top-right-buttons">
¬† <button class="button" onclick="goBack()">‚¨ÖÔ∏è Back</button>
¬† <button class="button" onclick="openSettings()">‚öôÔ∏è Settings</button>
</div>

<div id="welcome-screen" class="screen active">
  <h2>üéÆ NUMSHIFT - Sliding Puzzle Game</h2>
  <input type="text" id="username" placeholder="Enter your username" autocomplete="off" />
  <button class="button" id="start-button" onclick="startGameSetup()" disabled>Start Game</button>
</div>

<div id="player-screen" class="screen">
  <h2>Welcome, <span id="player-name">Player</span></h2>
  <p>Your Game ID: <span id="game-id">#12345</span></p>
  <p>Select your difficulty</p>
  <button class="button" onclick="selectDifficulty('easy')">Easy</button>
  <button class="button" onclick="selectDifficulty('medium')">Medium</button>
  <button class="button" onclick="selectDifficulty('hard')">Hard</button>
</div>

<div id="levels-screen" class="screen">
  <h2>üß© Select Level</h2>
  <div id="levels"></div>
  <div id="leaderboard-section">
    <div id="leaderboard-title">üèÜ Leaderboard (Best Times & Moves)</div>
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>Level</th>
          <th>Time (s)</th>
          <th>Moves</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>
</div>

<div id="game-screen" class="screen">
  <h2>üß† Puzzle In Progress</h2>
  <p>Moves: <span id="move-counter">0</span></p>
  <p>Time: <span id="timer">0</span> seconds</p>
  <div class="grid" id="grid"></div>
  <div style="display: flex; justify-content: center; flex-wrap: wrap; gap:10px; margin-top: 5px;">
    <button class="button" id="undo-button" onclick="undoMove()" disabled>‚Ü©Ô∏è Undo Move</button>
    <button class="button" id="pause-button" onclick="togglePause()">‚è∏Ô∏è Pause Timer</button>
    <button class="button" id="skip-button" onclick="skipLevel()">‚è≠Ô∏è Skip Level</button>
    <button class="button" id="show-solution-button" onclick="showSolution()">üîç Show Solution</button>
    <button class="button" onclick="resetGame()">üîÅ Reset</button>
  </div>
¬† <audio id="move-sound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YRAAAAAA"></audio>
  <audio id="win-sound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YRAAAAAA"></audio>
</div>

<div id="settings-screen" class="screen">
  <h2>‚öôÔ∏è Settings</h2>
  <div class="settings-section">
    <label for="change-username">üë§ Change Username:</label>
    <div style="display: flex; gap: 10px; margin-top: 8px;">
      <input type="text" id="change-username" placeholder="New username" class="username-input" autocomplete="off" />
      <button class="button" onclick="changeUsername()" style="width: auto; padding: 0 15px;">Save</button>
     </div>
  </div>
  <div class="settings-section">
    <label for="music-volume">üéµ Background Music Volume: <span id="music-volume-label">50%</span></label>
    <input type="range" id="music-volume" min="0" max="100" value="50" />
  </div>
  <div class="settings-section">
    <label for="sfx-volume">üîä Sound Effects Volume: <span id="sfx-volume-label">50%</span></label>
    <input type="range" id="sfx-volume" min="0" max="100" value="50" />
  </div>
  <div class="settings-section" style="display: flex; align-items: center; gap: 10px;">
    <label for="sfx-toggle" style="margin:0;">üîà Sound Effects: </label>
    <input type="checkbox" id="sfx-toggle" checked />
  </div>
  <div style="width: 100%; text-align: left; margin-bottom: 15px;">
    <label>‚ùì How to Play:</label>
    <p style="font-size: 14px; line-height: 1.4;">
      Rearrange the numbered tiles by sliding them into the empty space.<br/>
      Complete the puzzle by arranging the tiles in ascending order.<br/>
      Use the Undo and Pause buttons as needed.<br/>
      Your moves and time are recorded on the leaderboard.<br/>
    </p>
  </div>
  <div style="width: 100%; text-align: left;">
    <label>üìå Additional Features:</label>
    <ul style="font-size: 14px; line-height: 1.4;">
      <li>Show Solution to briefly preview the solved puzzle.</li>
      <li>Pause and resume the timer at any time.</li>
      <li>Undo one move to correct mistakes.</li>
      <li>Skip current level to advance.</li>
    </ul>
  </div>
</div>

<!-- Congratulatory Modal -->
<div id="congratulations-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>üéâ Congrats! You finished Level <span id="modal-level"></span>!</h2>
    <p>You completed it in <span id="modal-time"></span> seconds with <span id="modal-moves"></span> moves!</p>
    <div class="modal-buttons">
      <button class="button" onclick="nextLevel()">Next Level</button>
      <button class="button" onclick="goBackToDifficulty()">Back to Difficulty</button>
    </div>
  </div>
</div>

<audio id="background-music" loop preload="auto">
    <source src="assets/audio/bgm3.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<script>
  let difficulty = "easy";
  let maxLevel = 5;
  let completedLevels = 1;
  let currentLevel = 1;
  let gridSize = 3;
  let tiles = [];
  let emptyTile = {};
  let moveCounter = 0;
  let timeElapsed = 0;
  let timer;
  let timerPaused = false;
  let lastMove = null;
  let usernameStored = "";
  let screenHistory = [];

  let sfxEnabled = true;
  let sfxVolume = 50;

  let backgrounds = [
  "linear-gradient(135deg, #001933, #002a4d)",      // darker navy blue
  "linear-gradient(135deg, #3b006b, #6f21c2)",      // darker indigo-violet
  "linear-gradient(135deg, #cc654c, #d68a5e)",      // darker peach-orange
  "linear-gradient(135deg, #009acc, #005bb5)",      // darker cyan-blue
  "linear-gradient(135deg, #e699a8, #e6b3a0)"        // darker pink-beige
];
  const backgroundMusic = document.getElementById("background-music");
  let audioContext;

  // Enable start button on input username
  document.getElementById("username").addEventListener("input", function () {
    const username = this.value.trim();
    document.getElementById("start-button").disabled = username === "";
  });

  // Start game setup from welcome screen - store username and go to player screen
  function startGameSetup() {
    const usernameInput = document.getElementById("username");
    const username = usernameInput.value.trim();
    if (username === "") {
      alert("Please enter a username to start the game.");
      return;
    }
    usernameStored = username;
    localStorage.setItem('gameUsername', usernameStored);
    document.getElementById("player-name").textContent = usernameStored;
    switchScreen("welcome-screen", "player-screen");
  }

  function switchScreen(from, to) {
    document.getElementById(from).classList.remove("active");
    document.getElementById(to).classList.add("active");
    updateTopButtonsVisibility (to);
  }

  function updateTopButtonsVisibility(screenId) {
    const backButton = document.getElementById("back-button");
    const settingsButton = document.getElementById("settings-button");
    if (!backButton || !settingsButton) return;

    if (screenId === "settings-screen" || screenId === "game-screen") {
      backButton.style.display = "inline-block";
      settingsButton.style.display = "none";
    } else {
      backButton.style.display = "none";
      settingsButton.style.display = "inline-block";
    }
  }

  function goBack() {
    if (screenHistory.length === 0) {
      switchScreen(document.querySelector(".screen.active").id, "welcome-screen");
      return;
    }
    const lastScreen = screenHistory.pop();
    switchScreen(document.querySelector(".screen.active").id, lastScreen);
  }

  function selectDifficulty(selected) {
    difficulty = selected;
    screenHistory.push("player-screen");
    switchScreen("player-screen", "levels-screen");
    showLevels();
  }

  function showLevels() {
    let levelsDiv = document.getElementById("levels");
    levelsDiv.innerHTML = "";
    for (let i = 1; i <= maxLevel; i++) {
      let btn = document.createElement("button");
      btn.innerText = `Level ${i}`;
      btn.className = "button";
      btn.disabled = i > completedLevels;
      btn.onclick = () => startGame(i);
      levelsDiv.appendChild(btn);
    }
    updateLeaderboard();
  }

  function startGame(level) {
    currentLevel = level;
    gridSize = level + 2;
    screenHistory.push("levels-screen");
    switchScreen(document.querySelector(".screen.active").id, "game-screen");
    changeBackground();
    initGrid();
    startTimer();
  }

  function initGrid() {
    let grid = document.getElementById("grid");
    grid.innerHTML = "";
    grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
    tiles = [];
    let numbers = Array.from({ length: gridSize * gridSize }, (_, i) => i);
    shuffleArray(numbers);
    numbers.forEach((num, index) => {
      let tile = document.createElement("div");
      tile.classList.add("tile");
      if (num === 0) {
        tile.classList.add("empty");
        emptyTile = { index, element: tile };
        tile.textContent = "";
        tile.onclick = null;
      } else {
        tile.textContent = num;
        tile.onclick = () => moveTile(index);
      }
      tiles.push(tile);
      grid.appendChild(tile);
    });
    moveCounter = 0;
    timeElapsed = 0;
    timerPaused = false;
    document.getElementById("move-counter").textContent = moveCounter;
    document.getElementById("timer").textContent = timeElapsed;
    lastMove = null;
    document.getElementById("undo-button").disabled = true;
    document.getElementById("pause-button").textContent = "‚è∏Ô∏è Pause Timer";
  }

  function moveTile(index) {
    if (timerPaused) return;
    let row = Math.floor(index / gridSize);
    let col = index % gridSize;
    let emptyRow = Math.floor(emptyTile.index / gridSize);
    let emptyCol = emptyTile.index % gridSize;
    if ((Math.abs(row - emptyRow) === 1 && col === emptyCol) ||
        (Math.abs(col - emptyCol) === 1 && row === emptyRow)) {
      swapTiles(index, emptyTile.index);
      moveCounter++;
      document.getElementById("move-counter").textContent = moveCounter;
      lastMove = { fromIndex: index, toIndex: emptyTile.index };
      document.getElementById("undo-button").disabled = false;
      playMoveSound();
    }
  }

  function swapTiles(tileIndex, emptyIndex) {
    let tempText = tiles[tileIndex].textContent;
    tiles[tileIndex].textContent = "";
    tiles[tileIndex].classList.add("empty");
    tiles[tileIndex].onclick = null;
    tiles[emptyIndex].textContent = tempText;
    tiles[emptyIndex].classList.remove("empty");
    tiles[emptyIndex].onclick = () => moveTile(emptyIndex);
    emptyTile.index = tileIndex;
    emptyTile.element = tiles[tileIndex];
    checkWin();
  }

  function undoMove() {
    if (!lastMove || timerPaused) return;
    swapTiles(lastMove.toIndex, lastMove.fromIndex);
    moveCounter = Math.max(0, moveCounter - 1);
    document.getElementById("move-counter").textContent = moveCounter;
    lastMove = null;
    document.getElementById("undo-button").disabled = true; 
    playMoveSound();
  }

  function checkWin() {
    for (let i = 0; i < tiles.length; i++) {
      if (i === tiles.length - 1) {
        if (!tiles[i].classList.contains("empty")) return;
      } else {
        if (tiles[i].textContent != i + 1) return;
      }
    }
    clearInterval(timer);
    playWinSound();
    showCongratulationsModal();
    completedLevels = Math.max(completedLevels, currentLevel + 1);
    updateLeaderboardOnWin();
    showLevels();
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function startTimer() {
    clearInterval(timer);
    timerPaused = false;
    timeElapsed = 0;
    document.getElementById("pause-button").textContent = "‚è∏Ô∏è Pause Timer";
    timer = setInterval(() => {
      timeElapsed++;
      document.getElementById("timer").textContent = timeElapsed;
    }, 1000);
  }

  function togglePause() {
    if (!timer) return;
    if (timerPaused) {
      timerPaused = false;
      document.getElementById("pause-button").textContent = "‚è∏Ô∏è Pause Timer";
      timer = setInterval(() => {
        timeElapsed++;
        document.getElementById("timer").textContent = timeElapsed;
      }, 1000);
    } else {
      timerPaused = true;
      document.getElementById("pause-button").textContent = "‚ñ∂Ô∏è Resume Timer";
      clearInterval(timer);
    }
  }

  function skipLevel() {
    closeModal();
    if (currentLevel < maxLevel) {
      currentLevel++;
      startGame(currentLevel);
    } else {
      alert("You have reached the last level.");
    }
  }

  function resetGame() {
    clearInterval(timer);
    initGrid();
    startTimer();
    lastMove = null;
    document.getElementById("undo-button").disabled = true;
  }

  function showSolution() {
    disableGameControls(true);
    const backupTexts = tiles.map(t => t.textContent);
    const backupClasses = tiles.map(t => t.className);
    for (let i = 0; i < tiles.length; i++) {
      if (i === tiles.length - 1) {
        tiles[i].textContent = "";
        tiles[i].className = "tile empty";
        tiles[i].onclick = null;
      } else {
        tiles[i].textContent = (i + 1).toString();
        tiles[i].className = "tile";
        tiles[i].onclick = () => moveTile(i);
      }
    }
    setTimeout(() => {
      for (let i = 0; i < tiles.length; i++) {
        tiles[i].textContent = backupTexts[i];
        tiles[i].className = backupClasses[i];
        if (!tiles[i].classList.contains("empty")) {
          tiles[i].onclick = () => moveTile(i);
        } else {
          tiles[i].onclick = null;
          emptyTile = { index: i, element: tiles[i] };
        }
      }
      disableGameControls(false);
    }, 3000);
  }

  function disableGameControls(disable) {
    document.getElementById("undo-button").disabled = disable || lastMove === null;
    document.getElementById("pause-button").disabled = disable;
    document.querySelector("#game-screen button[onclick='showSolution()']").disabled = disable;
    document.querySelector("#game-screen button[onclick='resetGame()']").disabled = disable;
    document.getElementById("skip-button").disabled = disable;
  }

  function updateLeaderboard() {
    const tbody = document.getElementById("leaderboard-body");
    tbody.innerHTML = "";
    const data = getLeaderboardData();
    for (let lvl = 1; lvl <= maxLevel; lvl++) {
      let tr = document.createElement("tr");
      let tdLevel = document.createElement("td");
      tdLevel.textContent = "Level " + lvl;
      let tdTime = document.createElement("td");
      let tdMoves = document.createElement("td");
      if (data[lvl]) {
        tdTime.textContent = data[lvl].time;
        tdMoves.textContent = data[lvl].moves;
      } else {
        tdTime.textContent = "-";
        tdMoves.textContent = "-";
      }
      tr.appendChild(tdLevel);
      tr.appendChild(tdTime);
      tr.appendChild(tdMoves);
      tbody.appendChild(tr);
    }
  }

  function getLeaderboardData() {
    let key = `leaderboard_${difficulty}`;
    let stored = localStorage.getItem(key);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch (e) {
        return {};
      }
    }
    return {};
  }

  function updateLeaderboardOnWin() {
    let data = getLeaderboardData();
    let level = currentLevel;
    if (!data[level] || timeElapsed < data[level].time || (timeElapsed === data[level].time && moveCounter < data[level].moves)) {
      data[level] = { time: timeElapsed, moves: moveCounter };
      let key = `leaderboard_${difficulty}`;
      localStorage.setItem(key, JSON.stringify(data));
    }
  }

  function loadSettings() {
    const savedUsername = localStorage.getItem('gameUsername');
    if (savedUsername) {
      usernameStored = savedUsername;
      document.getElementById("player-name").textContent = usernameStored;
      document.getElementById("username").value = usernameStored;
      document.getElementById("start-button").disabled = false;
    }
    const storedVolume = localStorage.getItem('musicVolume');
    if (storedVolume !== null) {
      musicVolume = parseInt(storedVolume);
    }
    const storedSFX = localStorage.getItem('sfxEnabled');
    if (storedSFX !== null) {
      sfxEnabled = storedSFX === 'true';
    }
    const storedSFXVolume = localStorage.getItem('sfxVolume');
    if (storedSFXVolume !== null) {
      sfxVolume = parseInt(storedSFXVolume);
    }
    document.getElementById('music-volume').value = musicVolume;
    document.getElementById('music-volume-label').textContent = musicVolume + '%';
    document.getElementById('sfx-toggle').checked = sfxEnabled;
    document.getElementById('sfx-volume').value = sfxVolume;
    document.getElementById('sfx-volume-label').textContent = sfxVolume + '%';
    backgroundMusic.volume = musicVolume / 100;
  }

  function saveSettings() {
    localStorage.setItem('musicVolume', musicVolume);
    localStorage.setItem('sfxEnabled', sfxEnabled);
    localStorage.setItem('sfxVolume', sfxVolume);
  }

  function openSettings() {
    const currentScreen = document.querySelector(".screen.active").id;
    screenHistory.push(currentScreen);
    switchScreen(currentScreen, "settings-screen");
  }

  document.getElementById('music-volume').addEventListener('input', (e) => {
    musicVolume = parseInt(e.target.value);
    document.getElementById('music-volume-label').textContent = musicVolume + '%';
    backgroundMusic.volume = musicVolume / 100;
    saveSettings();
  });

  document.getElementById('sfx-toggle').addEventListener('change', (e) => {
    sfxEnabled = e.target.checked;
    saveSettings();
  });

  document.getElementById('sfx-volume').addEventListener('input', (e) => {
    sfxVolume = parseInt(e.target.value);
    document.getElementById('sfx-volume-label').textContent = sfxVolume + '%';
    saveSettings();
  });

  function changeUsername() {
    const newName = document.getElementById("change-username").value.trim();
    if (newName === "") {
      alert("Username cannot be empty.");
      return;
    }
    usernameStored = newName;
    localStorage.setItem('gameUsername', usernameStored);
    document.getElementById("player-name").textContent = usernameStored;
    alert("Username changed successfully.");
  }

  function showCongratulationsModal() {
    document.getElementById("modal-level").textContent = currentLevel;
    document.getElementById("modal-time").textContent = timeElapsed;
    document.getElementById("modal-moves").textContent = moveCounter;
    document.getElementById("congratulations-modal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("congratulations-modal").style.display = "none";
  }

  function nextLevel() {
    closeModal();
    if (currentLevel < maxLevel) {
      currentLevel++;
      startGame(currentLevel);
    } else {
      alert("You have reached the last level.");
    }
  }

  function goBackToDifficulty() {
    closeModal();
    switchScreen(document.querySelector(".screen.active").id, "player-screen");
  }

  function changeBackground() {
    document.body.style.background = backgrounds[currentLevel - 1] || backgrounds[0];
  }

  function initAudioContext() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
 if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    backgroundMusic.loop = true;
    backgroundMusic.volume = musicVolume / 100;
    backgroundMusic.play().catch((e) => {
      console.warn("Autoplay blocked until user gesture:", e);
    });
  }

  function unlockAudioOnUserGesture() {
    initAudioContext();
    document.body.removeEventListener('click', unlockAudioOnUserGesture);
    document.body.removeEventListener('keydown', unlockAudioOnUserGesture);
  }

  function playMoveSound() {
    if (!sfxEnabled) return;
    const moveSound = document.getElementById("move-sound");
    moveSound.volume = sfxVolume / 100;
    moveSound.currentTime = 0;
    moveSound.play().catch(() => { });
  }

  function playWinSound() {
    if (!sfxEnabled) return;
    const winSound = document.getElementById("win-sound");
    winSound.volume = sfxVolume / 100;
    winSound.currentTime = 0;
    winSound.play().catch(() => { });
  }

  window.onload = () => {
    loadSettings();
    if (usernameStored) {
      document.getElementById("start-button").disabled = false;
    }
    updateTopButtonsVisibility(document.querySelector(".screen.active").id);
    showLevels();
  };

  document.body.addEventListener('click', unlockAudioOnUserGesture);
  document.body.addEventListener('keydown', unlockAudioOnUserGesture);

</script>
</body>
</html>